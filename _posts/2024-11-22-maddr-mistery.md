---
layout: post
title:  "MADDRの謎"
date:   2024-11-22 14:05 +0900
categories: programming BDR
author: ark231
---
ここ数日CH32V003のDMAのデバッグを続けているが、一向に動かない。分かったことといえば、メモリアドレスの指定がうまく行っていないようだという事だ。  
<!-- more -->
CH32V003では、`DMA_MADDRx`(xにチャンネル番号が入る)というレジスタにDMAの読み取り元または書き込み先となる**メモリ**アドレスを指定する。そしてそれをちゃんと実装したはずなのだが、書き込んだあとにいくら確認しても0のままで正しいアドレスにならない。  
リファレンスには`DMA_CFGRx`の`EN`ビットが立っている、すなわちDMAが実行中の場合には書き込めないと書いてあるが、今回は`EN`ビットは立っていない。`if`文を仕込んで実際に確かめた。  
また、ch32v003funのレジスタ変数はすべてvolatile指定されているはずだが、念の為逆アセンブルしてコードを確認までした。ちゃんとレジスタのアドレスに書き込む命令が出力されていた。  
こうなるといよいよ訳がわからない。今回は個人的な趣味で既存のDMAの実装を見ないようにしていたが、もはや解禁するしかないのだろうか。  
DMAを諦めるという選択肢も無くはないが、256バイト書き込みの場合DMAなしだと5~600us消費する。IMUだけで300us程度消費しているので、温度気圧センサーを追加することを考えると1kHzでの記録が厳しくなってしまう。ESP32ならもう一つのコアに逃げられるのだが、今回はそうは行かない。  

どうやら`DMA_CNTRx`の書き込みもうまくいっていなさそうだ。何一つ書き込めていない。もしかして書き込んでから反映されるまでにタイムラグがあるのだろうか。しかし、`MADDR`に関してはwhileループで監視しているのでそういうわけでもなさそうである。また、リファレンスに`RW`と記載されているので読むこともできるはずである。  

正直ここまで詰まるとは予想していなかった。MPU6050に関しては、ESPでライブラリを作った経験から比較的すぐに実装できるだろうと踏んでいて実際できた[^mpu6050-fast]のだが、SPIフラッシュに関しては今まで一度もライブラリを作った経験がなく、何なら低レベルAPI[^low-level-api]にすら触れたことなかったため、もとから未知数ではあった。だが、それを乗り越えDMAなしの実装まではなんとかこなせた。だが、そこからDMAを有効化した途端全く動かなくなった。ESPも含めDMAを触るのは初めてだったため最初から動くとは思っていなかった。だから先にDMA無しバージョンを作ってプロトコル自体の動作確認をした。しかしながらここまでわけのわからない状態になるとは思わなかった。

[^mpu6050-fast]: ESP/Arduinoで実装してからch32v003funに移植したのも一因だろう
[^low-level-api]: ブロック消去とかが必要なもの
